# StellariaPact

StellariaPact 是一个为社区治理设计的 Discord 机器人，旨在通过一系列结构化的指令和自动化流程，维护提案讨论、投票和执行的流程。

## 🚀 功能总览

StellariaPact 提供了从提案发起、讨论、执行到异议处理的全生命周期管理功能。其核心工作流如下：

```mermaid
graph TD
    A[开始: 新提案] --> B{讨论中};
    B --> C{/进入执行};
    C -- 双重确认 --> D[执行中];
    D --> E{/废弃};
    D --> F[已结束];
    E --> G[已废弃];
    B -- /发起异议 --> H{异议处理};
    H -- 投票通过 --> I[已否决];
    H -- 投票驳回 --> B;
    D -- /发起异议 --> H;
```

### 角色与权限

机器人的操作权限与 Discord 角色绑定。各项关键操作需要特定角色才能执行：

- 管理组 (`stewards`): 拥有管理权限。
- 议事督导 (`councilModerator`): 负责监督提案讨论和流程。
- 执行监理 (`executionAuditor`): 负责监督提案的执行过程。

权限配置位于 `config.json` 文件中

### 提案状态

每个提案都有一个明确的状态标签，以追踪其在生命周期中的位置：

- 讨论中: 提案的初始状态，社区成员可在此阶段自由讨论。
- 执行中: 提案已获得批准，进入方案落地阶段。
- 冻结中: 提案因收到有效异议而被暂停，等待异议处理结果。
- 异议投票中: 针对提案的异议正在进行投票。
- 已结束: 提案流程正常完成。
- 已废弃: 提案在执行过程中因故被中止。
- 已否决: 提案在讨论或异议阶段被投票驳回。

## 指令手册

### 提案生命周期 (Lifecycle)

#### `/进入执行`
- 功能: 将一个处于 `[讨论中]` 状态的提案推进到 `[执行中]` 状态。
- 权限: `议事督导` + `执行监理`
- 流程:
    1. 指令发起者在提案帖中使用此命令。
    2. Bot 发出一个确认面板，需要另一角色的成员点击确认。
    3. 获得双方确认后，提案状态变更为 `[执行中]`，并发出通知。

#### `/废弃`
- 功能: 中止一个正在 `[执行中]` 的提案。
- 权限: `执行监理`
- 流程:
    1. `执行监理` 在提案帖中使用此命令。
    2. Bot 将提案状态更新为 `[已废弃]`，发布通知并锁定帖子。

### 异议处理 (Objection)

#### `/发起异议`
- 功能: 对一个正在进行中的提案发起异议。
- 权限: 所有社区成员
- 流程:
    1. 用户在任意频道使用此命令，并通过弹窗填写异议理由和目标提案链接。
    2. 系统记录异议，并根据是否为首次异议决定所需的支持票数（首次为5票，后续为10票）。
    3. 在指定频道创建异议收集面板，供社区成员投票支持。
    4. 当支持票数达到要求后，原提案被标记为 `[冻结中]`。
    5. 异议本身会进入正式投票，根据投票结果决定是推翻原提案还是驳回异议。

### 投票 (Voting)
- 功能: 为帖子提供通用的投票服务。
- 核心逻辑:
    1. Bot 会自动在提案频道的新帖子下创建投票面板。
    2. 点击投票按钮，用户会看到一个私密的投票界面，其中显示自己的投票资格。
    3. 投票资格: 默认要求用户在当前帖子内有至少3条有效发言（长度超过5个字符且非纯表情）。
    4. 管理员可以调整投票持续时间（默认3天）和是否匿名（默认匿名）。
    5. 投票到期后，Bot 会自动公布结果。

### 管理 (Moderation)

#### `/踢出提案` (右键菜单指令)
- 功能: 剥夺某个用户在特定提案中的投票资格。
- 权限: `议事督导`
- 流程:
    1. `议事督导` 在提案帖中右键点击目标用户的消息，选择此应用指令。
    2. 在弹窗中填写理由。
    3. Bot 会将该用户在该提案的投票资格标记为无效，并发出公示。

### 通知 (Notification)

#### `/发布公示`
- 功能: 向社区发布一个官方公示。
- 权限: `管理组`
- 流程:
    1. 管理员使用此命令，并通过弹窗填写公示内容和持续时间。
    2. Bot 会在议事频道创建一个新的讨论帖，并转发公告到所有指定的通知频道。
    3. 公示期结束后，若无异议，提案将自动进入 `[执行中]` 状态。

---

## ⚡ 快速开始

要求: [Python 3.8+](https://www.python.org/downloads/)

1.  下载项目代码
    ```bash
    git clone https://github.com/warming-afternoon/StellariaPact.git
    cd StellariaPact
    ```

2.  创建并配置 `config.json`
    复制 `config.json.example` 并重命名为 `config.json`，然后填入你的 Discord Bot Token 等必要信息。

3.  运行安装脚本
    这将是您需要运行的唯一的安装命令。它会自动安装所有需要的工具和依赖。

    *   作为普通用户:
        ```bash
        python setup.py
        ```
    *   作为开发者:
        ```bash
        python setup.py dev
        ```
    脚本会自动处理好一切，并在结束后询问你是否立即启动机器人。

4.  日常运行
    安装完成后，你可以随时使用以下命令来启动机器人：
    ```bash
    uv run stellaria-pact
    ```

---

## 👨‍💻 开发指南 (For Developers)

`python setup.py dev` 命令会自动为你安装所有开发工具（如 `ruff`, `pre-commit`）并设置好 Git 钩子。

### 日常开发命令

所有命令都通过 `uv run` 执行，无需手动激活虚拟环境

*   运行机器人:
    ```bash
    uv run stellaria-pact
    ```

*   代码格式化:
    ```bash
    uv run ruff format .
    ```

*   代码检查:
    ```bash
    uv run ruff check .
    ```

### 依赖管理

*   添加新依赖:
    1.  手动将包名添加到 `pyproject.toml` 的 `dependencies` 或 `dev` 列表中。
    2.  运行 `uv pip install -e .[dev]` 或 `uv pip install .` 来更新环境。

*   更新锁文件:
    当你手动修改 `pyproject.toml` 后，运行以下命令来更新 `uv.lock` 文件，以保证所有协作者的环境一致性：
    ```bash
    uv pip compile pyproject.toml -o uv.lock